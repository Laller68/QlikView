/*! qliksense-orgchart-extension - v0.1.0 - 2015-01-08 14:01 */define([],function(){function a(){this.data,this.config={},this.init=!1,this.container,this.me}function b(a,b){for(var c={nodes:[],links:[]},d=[],e=0;e<a.length;e++)-1===d.indexOf(a[e].data[b.fieldSource])&&(d.push(a[e].data[b.fieldSource]),c.nodes.push(a[e].data));for(var e=0;e<a.length;e++){var f=d.indexOf(a[e].data[b.fieldTarget]),g=d.indexOf(a[e].data[b.fieldSource]);-1!==f&&c.links.push({source:g,target:f,tri:a[e].data[b.keyField]})}return c}function c(){for(var a,b={},c=0,d=arguments.length;d>c;c++)for(a in arguments[c])arguments[c].hasOwnProperty(a)&&(b[a]=arguments[c][a]);return b}var d={image_path:"/site/employees/photos/smaller/",image_default:"person_default.jpg",image_extension:"jpg",fieldSource:"employeeID",fieldTarget:"managerID",keyField:"Trigram",tooltipTpl:null,width:960,height:480,url_pathname:""};return a.prototype=Object.create(Object.prototype,{initialize:{value:function(a,b){function e(){i.container.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}b||(b={}),this.config=c({},d,b),this.colors=d3.scale.category10();var f=this.config.width,g=this.config.height;this.zoom=d3.behavior.zoom().scaleExtent([.1,5]).translate([0,0]).on("zoom",e),this.main=d3.select(a).attr("class","qs-orgchart").append("svg").attr("width",f).attr("height",g);var h=this.main.append("g").attr("transform","translate(0,0)");h.append("defs").selectAll("marker").data(["suit","licensing","resolved"]).enter().append("marker").attr("id",function(a){return a}).attr("viewBox","0 -5 10 10").attr("refX",33).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5"),this.svg=h,this.svg.call(this.zoom),this.tooltip=d3.select(a).append("div").attr("class","tooltip").style("opacity",0);h.append("rect").attr("class","zoomRect").attr("width",f).attr("height",g).style("fill","none").style("pointer-events","all");this.container=h.append("g"),this.force=d3.layout.force().gravity(.06).distance(100).charge(-350).size([f,g]);var i=this;this.init=!0}},clear:{value:function(){this.values={nodes:[],links:[]},this.render()}},render:{value:function(){this.force.nodes(this.values.nodes).links(this.values.links).start(),window.setTimeout(function(){var a=this.config,b=this.tooltip,c=this.me,d=this.colors;this.container.selectAll(".link").remove(),this.container.selectAll(".node").remove();var e=this.container.selectAll(".link").data(this.values.links);e.enter().insert("svg:line",".node").attr("class",function(b){return b[a.keyField]===c?"link me":"link"}).attr("marker-end",function(){return"url("+a.url_pathname+"#suit)"}),e.exit().remove();var f=this.container.selectAll(".node").data(this.values.nodes),g=f.enter().append("g").attr("class","node").style("cursor","pointer").on("click",function(a){}).on("mouseover",function(c){a.tooltipTpl&&(b.transition().duration(200).style("opacity",.9),b.html(a.tooltipTpl(c)).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-70+"px"))}).on("mouseout",function(){a.tooltipTpl&&b.transition().duration(500).style("opacity",0)}).call(this.force.drag);g.append("circle").attr("r",function(b){return b[a.keyField]===c?30:15}).attr("stroke",function(b){return b[a.keyField]===c?"red":b.subnet===!0?"orange":void 0!==typeof b.color?d(b.color):"#509B1F"}).attr("stroke-width",function(b){return b[a.keyField]===c?"2px":"1px"}).attr("cx",0).attr("cy",0).attr("fill","white");var h=function(b){return b[a.keyField]===c?-20:-10},i=function(b){return b[a.keyField]===c?40:20};g.append("image").attr("id",function(b){return b[a.keyField]}).attr("xlink:href",function(){return a.image_default}).attr("x",h).attr("y",h).attr("width",i).attr("height",i),g.append("foreignObject").attr("width","200px").attr("height","50px").attr("x",15).attr("y",0).html(function(b){return'<div class="text">'+b[a.fieldSource]+"</div>"}),f.exit().remove(),this.force.on("tick",function(){e.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),f.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})}),this.force.on("end",function(){})}.bind(this),800)}},setData:{value:function(a,c){a&&(this.clear(),this.me=c.toUpperCase(),this.values=b(a,this.config),d3.transition().duration(500).tween("zoom",function(){return this.zoom.translate([0,0]).scale(1),function(){this.container.attr("transform","translate(0,0) scale(1)")}.bind(this)}.bind(this)),this.render())}},setMore:{value:function(a,c){a&&(this.clear(),this.me=c.toUpperCase(),this.values=b(a,this.config),this.render())}},setValues:{value:function(a,b){a&&(this.me=b.toUpperCase(),this.values=a,this.render())}}}),a});